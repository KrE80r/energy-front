<!DOCTYPE html>
<html>
<head>
    <title>Energy Locals Time-Based FiT Test</title>
</head>
<body>
    <h1>Energy Locals Time-Based Feed-in Tariff Test</h1>
    <div id="results"></div>

    <script src="js/calculator.js"></script>
    <script>
        // Test Energy Locals plan with time-based FiT
        const energyLocalsPlan = {
            retailer_name: 'Energy Locals',
            plan_name: 'Standing Offer',
            solar_feed_in_rate_r: 0,
            detailed_time_blocks: [
                {
                    name: 'Peak',
                    time_of_use_period: 'P',
                    description: '17:00 - 21:00'
                },
                {
                    name: 'Solar Sponge',
                    time_of_use_period: 'S',
                    description: '10:00 - 16:00'
                },
                {
                    name: 'Off Peak',
                    time_of_use_period: 'OP',
                    description: '21:00 - 10:00'
                }
            ]
        };

        // Test with 1000 kWh quarterly solar export
        const testSolarExport = 1000;
        const usagePattern = {
            persona: 'commuter'
        };

        // Test solar FiT extraction
        console.log('Testing solar FiT extraction...');
        const solarRates = extractSolarFitRates(energyLocalsPlan);
        console.log('Solar FiT rates found:', solarRates.length);
        solarRates.forEach(rate => {
            console.log(`- ${rate.displayName}: ${rate.rate}c/kWh (${rate.timeOfUsePeriod})`);
        });

        // Test time-based solar credit calculation
        console.log('\nTesting time-based solar credit calculation...');
        const solarCredit = calculateTieredSolarCredit(energyLocalsPlan, testSolarExport, usagePattern);
        console.log(`Solar credit for ${testSolarExport} kWh export: $${solarCredit.toFixed(2)}`);

        // Calculate expected result manually
        const exportDist = getSolarExportDistribution(usagePattern);
        console.log('\nExport distribution:', exportDist);
        
        let expectedCredit = 0;
        expectedCredit += (testSolarExport * exportDist.P / 100) * 15 / 100; // Peak: 15c
        expectedCredit += (testSolarExport * exportDist.S / 100) * 2 / 100;  // Shoulder: 2c
        expectedCredit += (testSolarExport * exportDist.OP / 100) * 5 / 100; // Off-peak: 5c
        
        console.log(`Expected credit: $${expectedCredit.toFixed(2)}`);
        console.log(`Calculation ${Math.abs(solarCredit - expectedCredit) < 0.01 ? 'PASSED' : 'FAILED'}`);

        // Display results
        document.getElementById('results').innerHTML = `
            <h2>Test Results</h2>
            <p><strong>Plan:</strong> ${energyLocalsPlan.retailer_name} - ${energyLocalsPlan.plan_name}</p>
            <p><strong>Solar export:</strong> ${testSolarExport} kWh/quarter</p>
            <p><strong>Time-based rates detected:</strong> ${solarRates.length > 0 ? 'Yes' : 'No'}</p>
            <p><strong>Solar credit calculated:</strong> $${solarCredit.toFixed(2)}</p>
            <p><strong>Expected credit:</strong> $${expectedCredit.toFixed(2)}</p>
            <p><strong>Status:</strong> ${Math.abs(solarCredit - expectedCredit) < 0.01 ? '✓ PASSED' : '✗ FAILED'}</p>
            
            <h3>Detected Time-Based Rates:</h3>
            <ul>
            ${solarRates.map(rate => 
                `<li>${rate.displayName}: ${rate.rate}c/kWh (${rate.description})</li>`
            ).join('')}
            </ul>
        `;
    </script>
</body>
</html>